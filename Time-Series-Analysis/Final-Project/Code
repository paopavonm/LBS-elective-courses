# Libraries
library(dygraphs) # For cute charts
library(zoo) #For moving averages
library(forecast) # To compare between years

# Importing data ---- 
setwd(getwd())
file_path <- file.path("Data", "Clean Data.csv")
data <- read.csv(file_path, header = TRUE)

colnames(data) <- c("Date", "Encounters")

# Date formating ---- 
# Is R taking our dates as real dates?
str(data) # Nope, it is character

# Let's change the dates to the correct format
data$Date <- as.Date(data$Date, format="%d/%m/%Y") # It is a date now but we 
                                                   # want the ISO format
data$Date <- as.Date(data$Date,format="%Y/%m/%d" )

# My data starts in October 1999 instead of January 2000 and that will bring 
# me trouble later on when plotting for seasonality. So let's remove those 3
# first rows.
data <- data[-(1:3),]

# TS object creation ----
FirstYear <- format(data$Date[1], "%Y")
FirstMonth <- format(data$Date[1], "%m")

apprehensionsTS <- ts(data$Encounters, start=c(FirstYear, FirstMonth), 
                    frequency=12)

str(apprehensionsTS)
head(apprehensionsTS)
tail(apprehensionsTS)

# Let's plot it!
dygraph(apprehensionsTS) |> dyRangeSelector()

# Trend ---- 
plot(apprehensionsTS, main="Total Migrant Apprehensions By Month - Southwest 
     Border", ylab= "Number of Encounters")
averages = rollmean(apprehensionsTS, k=12, align="right")
lines(averages, col="red") # We can clearly see that from early 2000 
                           # to around 2017 the trend was going down. Then
                           # it began increasing again with Trump.

# What has happened through the years?
ggseasonplot(apprehensionsTS, year.labels=TRUE,  ylab="Number of Encounters") 
# 2020 was the lowest but 2021-2023 were all very high.
# 2000 was also pretty high

# Seasonality ----
# What happens if we take out the trend from our TS?
decomposition <- decompose(apprehensionsTS)
str(decomposition)
plot(decomposition) # So yeah, clearly some seasonality there.
plot(decomposition$seasonal)

# What month is it where apprehensions are higher?
colours = ifelse(decomposition$figure > 0, "red", "gray")
barplot(decomposition$figure, names.arg = month.abb, col=colours) # What is 
# happening in March? 

# Correlation ----
#Economy ----
# Is migration correlated to lower economic growth?
file_path <- file.path("Data", "Mexico's economic growth.csv")
MexEcon <- read.csv(file_path, header = TRUE)
MexEcon <- MexEcon[,c(1,6)] # We are just interested in these two columns
MexEcon <- na.omit(MexEcon)
colnames(MexEcon) <- c("Date", "Index")

# Let's change the dates to the correct format
MexEcon$Date <- as.Date(MexEcon$Date, format="%d/%m/%Y")
MexEcon$Date <- as.Date(MexEcon$Date,format="%Y/%m/%d" )

# Now let's plot it
plot(apprehensionsTS, MexEcon$Index,
     main = "Apprehensions vs Mexican Economy",
     xlab = "Monthly apprehensions in US' Southwest boarder",
     ylab = "Mexican exonomy (base 100=01/01/2000",
     pch = 19)

# So units are aligned let's see the average of our apprehensions data
mean(apprehensionsTS) # So highest digit is ten thousand
MexEcon$Index <- MexEcon$Index * 1000

# Creating the TS...
FirstYear <- format(MexEcon$Date[1], "%Y")
FirstMonth <- format(MexEcon$Date[1], "%m")
MexEconTS <- ts(MexEcon$Index, start=c(FirstYear, FirstMonth), frequency=12)

# Plot both series together
dygraph(cbind(apprehensionsTS, MexEconTS)) |>
  dySeries("apprehensionsTS", label = "Apprehensions") |>
  dySeries("MexEconTS", label = "Economic Activity") |>
  dyRangeSelector()

# Are they correlated?
cor(apprehensionsTS, MexEconTS) # Not really

#Insecurity - homicides ----
# Is migration correlated to lower economic growth?
file_path <- file.path("Data", "Homicidios Mex.csv")
MexHom <- read.csv(file_path, header = TRUE)
MexHom <- MexHom[,c(1,4)] # We are just interested in these two columns
MexHom <- na.omit(MexHom)
colnames(MexHom) <- c("Date", "Homicides")

# Let's change the dates to the correct format
MexHom$Date <- as.Date(MexHom$Date, format="%d/%m/%Y")
MexHom$Date <- as.Date(MexHom$Date,format="%Y/%m/%d" )

# Our first plot
plot(window(apprehensionsTS, start = c(2000, 1), end = c(2023, 12)),
     MexHom$Homicides,
     main = "Apprehensions vs Insecurity in Mexico",
     xlab = "Monthly apprehensions in US' Southwest boarder",
     ylab = "Number of monthly homocides in Mexico",
     pch = 19) # Here we can see a bit more of a negative correlation? 

MexHom$Homicides <- as.numeric(MexHom$Homicides)*100

# Creating the TS...
FirstYear <- format(MexHom$Date[1], "%Y")
FirstMonth <- format(MexHom$Date[1], "%m")
MexHomTS <- ts(MexHom$Homicides, start=c(FirstYear, FirstMonth), frequency=12)

# Plot both series together
dygraph(cbind(apprehensionsTS, MexHomTS)) |>
  dySeries("apprehensionsTS", label = "Apprehensions") |>
  dySeries("MexHomTS", label = "Homicides") |>
  dyRangeSelector()

# Are they correlated?
start(apprehensionsTS)
start(MexHomTS)
common_start <- start(apprehensionsTS)

end(apprehensionsTS)
end(MexHomTS)
common_end <- end(MexHomTS)

app_trimmed <- window(apprehensionsTS, start = common_start, end = common_end)
hom_trimmed <- window(MexHomTS, start = common_start, end = common_end)
cor(app_trimmed, hom_trimmed) 

# YES! THEY ARE CORRELATED! 

# Climate ----
# This will be the most important one 
file_path <- file.path("Data", "Weather.csv")
Climate <- read.csv(file_path, header = TRUE)
Climate$Date <- as.Date(paste0(Climate$Date, "01"), format = "%Y%m%d")

# Our first plot
plot(apprehensionsTS,Climate$Value,
     main = "Apprehensions vs temperature",
     xlab = "Monthly apprehensions in US' Southwest boarder",
     ylab = "Temperature (°F)",
     pch = 19) # Difficult to see any correlation

Climate$Value <- as.numeric(Climate$Value)*1000

# Creating the TS...
FirstYear <- format(Climate$Date[1], "%Y")
FirstMonth <- format(Climate$Date[1], "%m")
ClimateTS <- ts(Climate$Value, start=c(FirstYear, FirstMonth), frequency=12)

# Plot both series together
dygraph(cbind(apprehensionsTS, ClimateTS)) |>
  dySeries("apprehensionsTS", label = "Apprehensions") |>
  dySeries("ClimateTS", label = "Temperature (°F)") |>
  dyRangeSelector()

cor(apprehensionsTS, ClimateTS) # A small, negative correlation
                                # Higher temperatures, less migration
# Autocorrelation ----
# Are monthly apprehensions correlated with past values? Let's find it out
Acf(apprehensionsTS, 
    main="ACF of monthly apprehensions using forecast::Acf function")
pacf(apprehensionsTS, 
    main="Partial autocorrelation of monthly apprehensions") # So in reality
# it is only correlated to itself and the one from one year ago

# Okay now let's plot the data again and let's add lines to different 
# presidents' terms

dygraph(apprehensionsTS) |> dyRangeSelector() |> 
  dyEvent("2001-01-20", "George W. Bush", color="red") |>
  dyEvent("2009-01-20", "Barack Obama", color="blue") |>
  dyEvent("2017-01-20", "Donald Trump", color="red") |>
  dyEvent("2021-01-20", "Joe Biden", color="blue") |>
  dyEvent("2025-01-20", "Donald Trump", color="red")

# Mean differences ----
# Let's analyze mean differences by presidents 
Bush <- window(apprehensionsTS, start = c(2001, 1), end = c(2009, 1))
Obama <- window(apprehensionsTS, start = c(2009, 1), end = c(2017, 1))
Trump <- window(apprehensionsTS, start = c(2017, 1), end = c(2021, 1))
Biden <- window(apprehensionsTS, start = c(2021, 1), end = c(2025, 1))

# Now let's built confidence intervals for each presidents' mean
# I will recycle this code so let's define a dummy variable
president <- Bush
n <- length(president)
average <-  mean(president)
stand_dev <-sd(president)
lower_bound <- average - pnorm(0.975)*stand_dev/sqrt(n)
upper_bound <- average + pnorm(0.975)*stand_dev/sqrt(n)

print(paste0("The confidence interval is: (", round(lower_bound,4), ",", 
             round(upper_bound,4),")."))

# Store the results here:
# Bush: The confidence interval is: (79301.8637,84772.9817)
# Obama: The confidence interval is: (33904.2413,35653.9855)
# Trump: The confidence interval is: (30519.1613,37081.6551)
# Biden: The confidence interval is: (126531.2599,141693.0666)

# Intervals of Obama and Trump do overlap eachother, meaning that there's
# no real mean difference there. However, Trump was only in power for 4 
# years, so maybe, not enough time for a significant change?

# Now I want to see if there is a difference before and after Trump,
before <- window(apprehensionsTS, start = c(2000, 1), end = c(2017, 1))
after <-  window(apprehensionsTS, start = c(2017, 2), end = c(2025, 1))

# Store the results here:
# Before: The confidence interval is: (60608.9251,65214.9286)
# After: The confidence interval is: (79256.1415,91230.3794)

# Was the difference Trump tho? Or Biden?
before <- window(apprehensionsTS, start = c(2000, 1), end = c(2021, 1))
after <-  window(apprehensionsTS, start = c(2021, 2), end = c(2025, 1))

# Store the results here:
# Before: The confidence interval is: (55339.5254,59455.6445)
# After: The confidence interval is: (129205.4447,144074.0969)

# Conclusion: there IS a difference in means before and after Trump 
# came into power. However, the mean only got more different after Biden's
# administration.
